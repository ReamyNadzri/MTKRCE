<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuih Recognition & Calories</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* --- ORIGINAL CSS VARIABLES & BASE STYLES --- */
        :root{
            --primary: #2aa05a;
            --primary-dark: #1e8f4a;
            --accent: #f4a261;
            --text-light: rgba(255,255,255,0.95);
            --text-muted: rgba(255,255,255,0.75);
            --glass-bg: rgba(255,255,255,0.08);
            --glass-border: rgba(255,255,255,0.15);
            --shadow-lg: 0 20px 60px rgba(0,0,0,0.4);
        }
        
        *{box-sizing:border-box;margin:0;padding:0}
        
        html,body{
            height:100%;
            font-family:'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow-x:hidden;
            scroll-behavior: smooth;
        }
        
        body{
            background: linear-gradient(135deg, #1a3a2e 0%, #2d5a45 50%, #3d6b59 100%);
            position:relative;
            color:var(--text-light);
            -webkit-font-smoothing:antialiased;
        }
        
        /* Background pattern */
        body::before{
            content:''; position:fixed; inset:0;
            background-image: radial-gradient(circle at 20% 30%, rgba(244,162,97,0.08) 0%, transparent 50%), radial-gradient(circle at 80% 70%, rgba(42,160,90,0.12) 0%, transparent 50%), url('data:image/svg+xml,<svg width="60" height="60" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="kuih-pattern" x="0" y="0" width="60" height="60" patternUnits="userSpaceOnUse"><circle cx="15" cy="15" r="2" fill="rgba(255,255,255,0.03)"/><circle cx="45" cy="45" r="2" fill="rgba(255,255,255,0.03)"/><path d="M30,10 Q35,20 30,30 Q25,20 30,10" fill="rgba(255,255,255,0.02)"/></pattern></defs><rect width="60" height="60" fill="url(%23kuih-pattern)"/></svg>');
            animation: backgroundShift 60s ease-in-out infinite; pointer-events:none; z-index:1;
        }
        @keyframes backgroundShift{ 0%, 100%{transform:translate(0,0) scale(1)} 50%{transform:translate(-20px,-20px) scale(1.05)} }
        
        /* Floating decorations */
        .decoration{ position:fixed; border-radius:50%; opacity:0.04; pointer-events:none; z-index:2; animation:float 20s ease-in-out infinite; }
        .decoration:nth-child(1){ width:200px;height:200px; background:radial-gradient(circle, var(--accent), transparent); top:10%;left:5%; animation-delay:0s; }
        .decoration:nth-child(2){ width:150px;height:150px; background:radial-gradient(circle, var(--primary), transparent); bottom:15%;right:8%; animation-delay:5s; }
        .decoration:nth-child(3){ width:180px;height:180px; background:radial-gradient(circle, rgba(255,255,255,0.3), transparent); top:50%;right:15%; animation-delay:10s; }
        @keyframes float{ 0%, 100%{transform:translate(0,0) scale(1)} 50%{transform:translate(-20px,20px) scale(0.9)} }
        
        /* Main container - Original Padding */
        .container{
            position:relative; z-index:10; min-height:100vh;
            display:flex; align-items:center; justify-content:center;
            padding:40px 20px;
            overflow: hidden;
        }
        
        .panel{
            width:100%; max-width:1100px;
            background:rgba(255,255,255,0.05); backdrop-filter:blur(30px) saturate(150%);
            -webkit-backdrop-filter:blur(30px) saturate(150%);
            border-radius:32px; border:1px solid var(--glass-border);
            box-shadow:var(--shadow-lg), inset 0 1px 0 rgba(255,255,255,0.1);
            animation:slideUp 0.8s ease-out;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; left: 0;
        }
        .panel.history-active { transform: translateX(-350px); }
        @keyframes slideUp{ from{opacity:0;transform:translateY(30px)} to{opacity:1;transform:translateY(0)} }
        
        /* Header section - Original Size */
        .header{
            background:linear-gradient(135deg, rgba(42,160,90,0.15), rgba(30,143,74,0.1));
            padding:40px;
            border-bottom:1px solid rgba(255,255,255,0.08);
            position:relative; display: flex; justify-content: space-between; align-items: center;
            border-top-left-radius: 32px; border-top-right-radius: 32px;
        }
        .brand{ display:flex; align-items:center; gap:20px; position:relative; z-index:2; }
        .logo{
            width:72px; height:72px; border-radius:20px;
            background:linear-gradient(135deg, var(--primary), var(--primary-dark));
            display:flex; align-items:center; justify-content:center;
            font-size:2rem; font-weight:700; color:white;
            box-shadow:0 10px 30px rgba(42,160,90,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
            transition:all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .logo:hover{ transform:translateY(-8px) rotate(5deg) scale(1.05); box-shadow:0 20px 50px rgba(42,160,90,0.5); }
        h1{
            font-family:'Playfair Display', serif; font-size:2.2rem; font-weight:700;
            background:linear-gradient(135deg, #fff, rgba(244,162,97,0.9));
            -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
            margin-bottom:8px; letter-spacing:-0.5px;
        }
        .subtitle{ color:var(--text-muted); font-size:1rem; font-weight:400; }
        
        /* Header Actions */
        .header-actions { display: flex; gap: 15px; align-items: center; z-index: 3; }
        .btn-history {
            background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border);
            color: var(--text-light); padding: 10px 18px; border-radius: 12px;
            cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;
            transition: all 0.3s ease; font-size: 1rem;
        }
        .btn-history:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); }
        .menu-icon{
            width: 44px; height: 44px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s ease; font-size: 1.2rem;
        }
        .menu-icon:hover{ background: rgba(255,255,255,0.2); transform: scale(1.1); }
        
        /* Content grid - Original Size */
        .content{ display:grid; grid-template-columns:1fr 380px; gap:32px; padding:40px; }
        
        /* Status badges */
        .status{ padding:14px 18px; border-radius:16px; margin-bottom:20px; font-weight:500; font-size:0.92rem; display:flex; align-items:center; gap:10px; backdrop-filter:blur(10px); }
        .status-ok{ background:rgba(40,167,69,0.15); border:1px solid rgba(40,167,69,0.3); color:#c9f0d5; }
        .status-warn{ background:rgba(255,193,7,0.1); border:1px solid rgba(255,193,7,0.25); color:#ffefc1; }
        .status-error{ background:rgba(220,53,69,0.1); border:1px solid rgba(220,53,69,0.25); color:#ffd2d6; }
        
        /* Upload section - Original Size */
        .upload-card{
            background:rgba(255,255,255,0.06); border:2px dashed rgba(255,255,255,0.15);
            border-radius:20px; padding:32px; text-align:center; transition:all 0.3s ease;
            position:relative; overflow:hidden; cursor:pointer; min-height:220px;
            display:flex; flex-direction:column; align-items:center; justify-content:center;
        }
        .upload-card:hover, .upload-card.drag-over{ border-color:var(--primary); background:rgba(42,160,90,0.15); transform:scale(1.02); }
        .upload-text h3{ font-size:1.2rem; margin-bottom:8px; color:var(--text-light); }
        
        .btn-primary{
            margin-top:20px; padding:14px 32px; background:linear-gradient(135deg, var(--primary), var(--primary-dark));
            color:white; border:none; border-radius:12px; font-weight:600; font-size:1rem;
            cursor:pointer; transition:all 0.3s ease; box-shadow:0 4px 15px rgba(42,160,90,0.3); width: 100%;
        }
        .btn-primary:hover{ transform:translateY(-2px); box-shadow:0 8px 25px rgba(42,160,90,0.5); }
        .btn-primary:disabled{ opacity:0.5; cursor:not-allowed; transform:none; }
        
        /* Results section */
        .results{ margin-top:24px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.1); border-radius:20px; padding:24px; backdrop-filter:blur(10px); }
        .results img{ width:100%; height:auto; border-radius:16px; margin:16px 0; box-shadow:0 8px 30px rgba(0,0,0,0.3); }
        .result-item{ margin:12px 0; padding:12px; background:rgba(255,255,255,0.03); border-radius:12px; border-left:3px solid var(--primary); }
        .result-item strong{ color:var(--accent); font-weight:600; }
        
        /* Calculator Section */
        .calculator-section {
            margin-top: 20px; padding: 20px; background: rgba(42, 160, 90, 0.1);
            border-radius: 16px; border: 1px solid rgba(42, 160, 90, 0.2);
        }
        .calc-input-group { display: flex; align-items: center; gap: 10px; margin-top: 15px; flex-wrap: wrap; font-size: 1.05rem; }
        .calc-input {
            background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border);
            color: white; padding: 10px 15px; border-radius: 10px; width: 80px; font-size: 1.1rem; text-align: center;
        }
        .calc-result { font-size: 1.4rem; font-weight: 700; color: var(--accent); }

        /* Feedback buttons */
        .feedback-buttons{ display:flex; gap:12px; margin-top:16px; }
        .btn-feedback{ flex:1; padding:12px; border:none; border-radius:12px; font-weight:600; cursor:pointer; transition:all 0.3s ease; font-size:0.95rem; }
        .btn-yes{ background:linear-gradient(135deg, #28a745, #20883a); color:white; }
        .btn-no{ background:linear-gradient(135deg, #dc3545, #c82333); color:white; }

        /* Sidebar cards - Original Size */
        .sidebar{ display:flex; flex-direction:column; gap:24px; }
        .card{ background:rgba(255,255,255,0.06); border:1px solid var(--glass-border); border-radius:20px; padding:24px; backdrop-filter:blur(10px); transition:all 0.3s ease; }
        .card:hover{ background:rgba(255,255,255,0.08); transform:translateY(-4px); box-shadow:0 12px 35px rgba(0,0,0,0.3); }
        .card h3{ font-family:'Playfair Display', serif; color:var(--accent); margin-bottom:12px; font-size:1.3rem; }
        .card p{ color:var(--text-muted); line-height:1.6; font-size:0.92rem; }
        .divider{ height:1px; background:linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); margin:16px 0; }
        .stats{ display:flex; gap:20px; margin-top:12px; }
        .stat-item{ flex:1; text-align:center; padding:12px; background:rgba(255,255,255,0.03); border-radius:12px; }
        .stat-value{ font-size:1.5rem; font-weight:700; color:var(--primary); display:block; }
        .stat-label{ font-size:0.8rem; color:var(--text-muted); margin-top:4px; }

        /* Identifiable Kuih List */
        .kuih-list { display: flex; flex-wrap: wrap; gap: 8px; max-height: 300px; overflow-y: auto; padding-right: 5px; }
        .kuih-tag { background: rgba(0,0,0,0.2); padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; color: var(--text-muted); border: 1px solid var(--glass-border); }
        .kuih-list::-webkit-scrollbar { width: 6px; }
        .kuih-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        /* Right-Side History Panel */
        .history-panel {
            position: absolute; top: 40px; right: 0;
            width: 330px; height: calc(100vh - 80px);
            background: rgba(20, 40, 35, 0.9); backdrop-filter: blur(30px);
            border-radius: 32px 0 0 32px; border: 1px solid var(--glass-border); border-right: none;
            padding: 30px;
            transform: translateX(100%); transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto; z-index: 9;
        }
        .history-panel.active { transform: translateX(0); right: 40px; }
        .panel { z-index: 10; }
        .history-item { padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--glass-border); }
        .history-date { font-size: 0.75rem; color: var(--accent); margin-bottom: 5px; opacity: 0.8; }
        .history-name { font-weight: 600; color: var(--text-light); }
        .history-cal { font-size: 0.9rem; color: var(--text-muted); }
        .close-history { position: absolute; top: 25px; right: 25px; background: none; border: none; color: var(--text-muted); font-size: 1.8rem; cursor: pointer; }

        /* Gemini Loader */
        .gemini-loading{text-align:center;padding:20px;color:var(--text-muted);font-size:1rem;}

        /* --- AGGRESSIVE MOBILE SCALING --- */
        @media (max-width: 968px) {
            .content{ grid-template-columns:1fr; }
            .panel.history-active { transform: translateX(-100%); opacity: 0.3; }
            .history-panel { width: 80%; right: 0; }
        }

        /* For Smartphones/Small Tablets */
        @media (max-width: 640px) {
            html { font-size: 14px; } /* Reduces base font size for everything using 'rem' */
            .container{ padding: 10px; }
            .panel{ border-radius: 20px; }
            .header{ padding: 20px; flex-direction: column; align-items: flex-start; gap: 15px; }
            .header-actions { width: 100%; justify-content: space-between; }
            .brand{ gap: 12px; }
            .logo{ width: 50px; height: 50px; font-size: 1.5rem; border-radius: 14px; }
            h1{ font-size: 1.6rem; }
            .content{ padding: 20px; gap: 20px; }
            .upload-card{ padding: 20px; min-height: 180px; }
            .upload-card h3 { font-size: 1.1rem; }
            .btn-primary{ padding: 12px 20px; font-size: 0.95rem; }
            
            /* Full width history on small screens */
            .history-panel { width: 100%; top: 0; height: 100vh; border-radius: 0; right: 0; padding: 20px; }
            .history-panel.active { right: 0; }
            .close-history { top: 15px; right: 15px; font-size: 2rem; padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="decoration"></div><div class="decoration"></div><div class="decoration"></div>
    
    <div class="container">
        <!-- Main Panel -->
        <main class="panel" id="mainPanel">
            <header class="header">
                <div class="brand">
                    <div class="logo">ü•ü</div>
                    <div>
                        <h1>Malaysian Traditional Kuih Recognition</h1>
                        <p class="subtitle">Discover traditional Malaysian kuih and their nutritional values</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn-history" onclick="toggleHistory()"><span>üìú</span> History</button>
                    <div class="menu-icon" onclick="window.location.href='/'" title="Reset App">üîÑ</div>
                </div>
            </header>
            
            <div class="content">
                <section class="main-content">
                    {% if error %}
                        <div class="status status-error">{{ error }}</div>
                    {% elif not model_loaded %}
                        <div class="status status-error">‚ö†Ô∏è Model not loaded. Prediction is unavailable.</div>
                    {% elif not db_connection_ok %}
                        <div class="status status-warn">‚ö†Ô∏è Database connection failed. Calorie lookup and feedback saving may not work.</div>
                    {% else %}
                        <div class="status status-ok">‚úÖ System ready. Model and Database connected.</div>
                    {% endif %}
                    
                    <form id="uploadForm" method="post" action="/predict" enctype="multipart/form-data">
                        <div class="upload-card" id="dropZone" onclick="document.getElementById('fileInput').click()">
                            <div style="font-size:3rem;opacity:0.6;margin-bottom:16px">üì∏</div>
                            <div class="upload-text">
                                <h3>Drop your kuih image here</h3>
                                <p>or click to browse</p>
                                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 8px;">Supported formats: PNG, JPG, JPEG, WEBP</p>
                            </div>
                            <input type="file" id="fileInput" name="file" accept="image/*" capture="environment" hidden>
                            <div id="fileName" style="margin-top:12px;padding:10px 16px;background:rgba(42,160,90,0.1);border:1px solid rgba(42,160,90,0.2);border-radius:10px;color:var(--text-light);font-size:0.9rem;display:none"></div>
                        </div>
                        <button type="submit" class="btn-primary" {% if not model_loaded %}disabled{% endif %}>üîç Identify Kuih</button>
                    </form>

                    {% if kuih_name and success %}
                    <div class="results" id="resultsSection">
                        <h3 style="font-family:'Playfair Display',serif;color:var(--accent);margin-bottom:12px">Prediction Results</h3>
                        {% if request_feedback %}<div class="status status-warn">Low confidence prediction. Your feedback is valuable!</div>{% endif %}
                        <img src="{{ url_for('serve_uploaded_file', filename=image_path) }}" alt="Uploaded Kuih">
                        
                        <div class="result-item"><strong>Kuih Type:</strong> <span id="predictedKuih">{{ kuih_name }}</span></div>
                        <div class="result-item"><strong>Confidence:</strong> {{ confidence }}</div>
                        <div class="result-item"><strong>Estimated Calories:</strong> <span id="baseCalories">{{ calories }}</span> kcal / serving</div>
                        {% if weight and weight != 'N/A' %}<div class="result-item"><strong>Weight:</strong> {{ weight }}g</div>{% endif %}

                        <!-- Calculator -->
                        <div class="calculator-section">
                            <h4 style="color:var(--text-light)">üßÆ Calorie Calculator</h4>
                            <div class="calc-input-group">
                                <span>I ate</span>
                                <input type="number" id="pieceInput" class="calc-input" value="1" min="0" step="0.5" oninput="calculateTotal()">
                                <span>pieces √ó {{ calories }} kcal =</span>
                                <span class="calc-result" id="totalCalories">{{ calories }}</span>
                                <span style="color:var(--accent)">kcal total</span>
                            </div>
                        </div>

                        <!-- Feedback -->
                        <div style="margin-top:20px">
                            <h4 style="margin-bottom:12px;color:var(--text-light)">Is this prediction correct?</h4>
                            <div class="feedback-buttons">
                                <button class="btn-feedback btn-yes" onclick="submitFeedback(true)">‚úÖ Yes, Correct</button>
                                <button class="btn-feedback btn-no" onclick="document.getElementById('correctionSection').style.display='block'">‚ùå No, Incorrect</button>
                            </div>
                            <div id="correctionSection" style="display:none;margin-top:16px;padding:16px;background:rgba(255,255,255,0.03);border-radius:12px">
                                <select id="actualKuihSelect" style="width:100%;padding:12px;border-radius:10px;background:rgba(255,255,255,0.05);color:var(--text-light);border:1px solid rgba(255,255,255,0.15);margin-bottom:12px;font-size:0.95rem">
                                    <option value="">-- Select Correct Kuih --</option>
                                    {% for k in available_classes %}<option value="{{k}}">{{k}}</option>{% endfor %}
                                </select>
                                <button onclick="submitCorrection()" class="btn-primary" style="margin-top:0">Submit Correction</button>
                            </div>
                            <div id="feedbackMessage" style="display:none;margin-top:16px;padding:14px;border-radius:12px;"></div>
                        </div>
                        <div id="hiddenData" style="display:none" data-kuih="{{ kuih_name }}" data-img="{{ image_path }}" data-cal="{{ calories }}"></div>
                    </div>
                    {% endif %}
                </section>
                
                <!-- Restored Original Sidebar -->
                <aside class="sidebar">
                    <div class="card">
                        <h3>Quick Tips</h3>
                        <p>For best results, upload clear, well-lit images with the kuih as the main focus. Avoid cluttered backgrounds.</p>
                    </div>
                    
                    <div class="card">
                        <h3>Feedback Stats</h3>
                        <div class="divider"></div>
                        <div class="stats">
                            <div class="stat-item"><span class="stat-value">{{ feedback_stats.total }}</span><span class="stat-label">Total</span></div>
                            <div class="stat-item"><span class="stat-value">{{ "%.0f"|format(feedback_stats.accuracy) }}%</span><span class="stat-label">Accuracy</span></div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Identifiable Kuih</h3>
                        <div class="divider"></div>
                        <div class="kuih-list">
                            {% for kuih in available_classes %}
                                <span class="kuih-tag">{{ kuih }}</span>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Gemini AI Card with 4 fields restored -->
                    <div class="card" id="gemini-card" style="display:none;">
                        <h3>Gemini AI Insights ‚ú®</h3>
                        <div class="divider"></div>
                        <div id="gemini-loading" class="gemini-loading">Analyzing with AI...</div>
                        <div id="gemini-content" style="display:none">
                            <div style="margin-bottom:15px">
                                <strong style="color:var(--accent)">Est. Calories:</strong>
                                <p id="ai-cal" style="color:var(--text-muted);margin-top:4px"></p>
                            </div>
                            <div style="margin-bottom:15px">
                                <strong style="color:var(--accent)">Other Names:</strong>
                                <p id="ai-names" style="color:var(--text-muted);margin-top:4px"></p>
                            </div>
                            <div style="margin-bottom:15px">
                                <strong style="color:var(--accent)">Description:</strong>
                                <p id="ai-desc" style="color:var(--text-muted);margin-top:4px;line-height:1.5"></p>
                            </div>
                            <div style="background:rgba(244,162,97,0.1);padding:12px;border-radius:10px;border-left:3px solid var(--accent)">
                                <strong style="color:var(--accent)">Fun Fact:</strong>
                                <span id="ai-fact" style="color:var(--text-light);display:block;margin-top:4px;line-height:1.5"></span>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </main>

        <div class="history-panel" id="historyPanel">
            <button class="close-history" onclick="toggleHistory()">√ó</button>
            <h2 style="font-family:'Playfair Display',serif; color:var(--accent); margin-bottom:20px; font-size:1.8rem">Scan History</h2>
            <div id="historyList">
                <div style="color:var(--text-muted);font-size:1rem">Loading history...</div>
            </div>
        </div>
    </div>

    <script>
        function toggleHistory() {
            const panel = document.getElementById('mainPanel');
            const history = document.getElementById('historyPanel');
            const isActive = panel.classList.contains('history-active');
            if (!isActive) {
                panel.classList.add('history-active'); history.classList.add('active'); fetchHistory();
            } else {
                panel.classList.remove('history-active'); history.classList.remove('active');
            }
        }
        async function fetchHistory() {
            const list = document.getElementById('historyList');
            try {
                const res = await fetch('/api/history'); const data = await res.json();
                if (data.length === 0) { list.innerHTML = '<div style="color:var(--text-muted)">No history yet.</div>'; return; }
                list.innerHTML = data.map(item => `
                    <div class="history-item">
                        <div class="history-date">${new Date(item.timestamp).toLocaleString([], {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'})}</div>
                        <div class="history-name">${item.kuih_name}</div>
                        <div class="history-cal">${item.calories} kcal</div>
                    </div>`).join('');
            } catch (e) { list.innerHTML = '<div style="color:#ffd2d6">Failed to load history.</div>'; }
        }
        function calculateTotal() {
            const pieces = document.getElementById('pieceInput').value || 0;
            const baseCal = parseInt(document.getElementById('hiddenData')?.getAttribute('data-cal'));
            document.getElementById('totalCalories').textContent = isNaN(baseCal) ? "N/A" : Math.round(pieces * baseCal).toLocaleString();
        }
        const dropZone=document.getElementById('dropZone'), fileInput=document.getElementById('fileInput'), fileName=document.getElementById('fileName');
        if(dropZone){
            ['dragenter','dragover','dragleave','drop'].forEach(e=>{dropZone.addEventListener(e,ev=>{ev.preventDefault();ev.stopPropagation()})});
            ['dragenter','dragover'].forEach(e=>dropZone.addEventListener(e,()=>dropZone.classList.add('drag-over')));
            ['dragleave','drop'].forEach(e=>dropZone.addEventListener(e,()=>dropZone.classList.remove('drag-over')));
            dropZone.addEventListener('drop',e=>{fileInput.files=e.dataTransfer.files;updateFileName()});
            fileInput.addEventListener('change',updateFileName);
        }
        function updateFileName(){
            if(!fileInput || !fileName) return;
            if(fileInput.files.length > 0){
                const name = fileInput.files[0].name;
                const max = 30;
                let displayName = name;
                if(name.length > max){
                    const dotIndex = name.lastIndexOf('.');
                    const ext = dotIndex > 0 ? name.slice(dotIndex) : '';
                    const avail = max - ext.length - 3; // room for '...'
                    const base = avail > 0 ? name.slice(0, avail) : name.slice(0, max - 3);
                    displayName = base + '...' + ext;
                }
                fileName.textContent = "Selected: " + displayName;
                fileName.title = name; // show full name on hover
                fileName.style.display = 'inline-block';
            } else {
                fileName.style.display = 'none';
            }
        }
        
        document.addEventListener('DOMContentLoaded',()=>{
            const hidden=document.getElementById('hiddenData');
            if(hidden){ loadGemini(hidden.getAttribute('data-kuih')); document.getElementById('resultsSection').scrollIntoView({behavior:'smooth',block:'start'}); }
        });
        async function loadGemini(kuihName){
            const card=document.getElementById('gemini-card'); if(!card)return; card.style.display='block';
            try{
                const res=await fetch('/gemini-info',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({kuih:kuihName})});
                const data=await res.json();
                document.getElementById('gemini-loading').style.display='none'; document.getElementById('gemini-content').style.display='block';
                // Updated to populate all 4 fields
                document.getElementById('ai-cal').textContent = data.estimatedcalories;
                document.getElementById('ai-names').textContent = data.othersname;
                document.getElementById('ai-desc').textContent = data.description;
                document.getElementById('ai-fact').textContent = data.fun_fact;
            }catch(e){ document.getElementById('gemini-loading').textContent="AI unavailable."; }
        }
        function showMsg(msg,s){
            const el=document.getElementById('feedbackMessage'); el.textContent=msg; el.style.display='block';
            el.style.background=s?'rgba(40,167,69,0.15)':'rgba(220,53,69,0.15)'; el.style.color=s?'#c9f0d5':'#ffd2d6';
            el.style.border=s?'1px solid rgba(40,167,69,0.3)':'1px solid rgba(220,53,69,0.3)';
        }
        function submitFeedback(c){sendFeedback(c,null)}
        function submitCorrection(){const a=document.getElementById('actualKuihSelect').value; if(!a)return showMsg('Select a kuih type.',false); sendFeedback(false,a)}
        function sendFeedback(c,a){
            const h=document.getElementById('hiddenData');
            fetch('/submit_feedback',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({predicted_label:h.getAttribute('data-kuih'),image_path:h.getAttribute('data-img'),is_correct:c,actual_label:a})})
            .then(r=>r.json()).then(d=>{showMsg(d.message,d.success);if(d.success&&!c)document.getElementById('correctionSection').style.display='none'});
        }
    </script>
</body>
</html>